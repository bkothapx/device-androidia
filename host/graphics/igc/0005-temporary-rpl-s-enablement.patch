From 4a79ec60b047fa08e1cb96cd360acbdff5698b19 Mon Sep 17 00:00:00 2001
From: Dongwon Kim <dongwon.kim@intel.com>
Date: Mon, 23 Aug 2021 16:15:35 -0700
Subject: [PATCH 5/5] temporary rpl-s enablement

Signed-off-by: Dongwon Kim <dongwon.kim@intel.com>
---
 IGC/Compiler/CISACodeGen/CISABuilder.cpp  |  1 +
 IGC/Compiler/CISACodeGen/EmitVISAPass.cpp |  3 ++-
 IGC/Compiler/CISACodeGen/Platform.hpp     |  5 ++++-
 IGC/common/ShaderOverride.cpp             |  1 +
 IGC/common/SystemThread.cpp               |  1 +
 IGC/common/VCPlatformSelector.hpp         |  2 ++
 inc/common/igfxfmid.h                     | 11 +++++++++++
 7 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/IGC/Compiler/CISACodeGen/CISABuilder.cpp b/IGC/Compiler/CISACodeGen/CISABuilder.cpp
index 90f1f5afae2d..9c6562dad592 100644
--- a/IGC/Compiler/CISACodeGen/CISABuilder.cpp
+++ b/IGC/Compiler/CISACodeGen/CISABuilder.cpp
@@ -2996,6 +2996,7 @@ namespace IGC
                 || platform->getPlatformInfo().eProductFamily == IGFX_ROCKETLAKE
                 || platform->getPlatformInfo().eProductFamily == IGFX_ALDERLAKE_S
                 || platform->getPlatformInfo().eProductFamily == IGFX_ALDERLAKE_P
+                || platform->getPlatformInfo().eProductFamily == IGFX_RAPTORLAKE_S
                )
             {
                 return GENX_TGLLP;
diff --git a/IGC/Compiler/CISACodeGen/EmitVISAPass.cpp b/IGC/Compiler/CISACodeGen/EmitVISAPass.cpp
index 8355ef0136a0..8188ca0b3058 100644
--- a/IGC/Compiler/CISACodeGen/EmitVISAPass.cpp
+++ b/IGC/Compiler/CISACodeGen/EmitVISAPass.cpp
@@ -693,7 +693,8 @@ bool EmitPass::runOnFunction(llvm::Function& F)
                 }
             }
             if ((IGC_GET_FLAG_VALUE(CodePatchFilter) & (0x1 << 0x4)) &&
-                    m_pCtx->platform.getPlatformInfo().eProductFamily == IGFX_ALDERLAKE_P) {
+                    ((m_pCtx->platform.getPlatformInfo().eProductFamily == IGFX_ALDERLAKE_P) ||
+                    (m_pCtx->platform.getPlatformInfo().eProductFamily == IGFX_RAPTORLAKE_S))) {
                 m_encoder->SetIsCodePatchCandidate(false);
             }
         }
diff --git a/IGC/Compiler/CISACodeGen/Platform.hpp b/IGC/Compiler/CISACodeGen/Platform.hpp
index df427ce364ee..e9f51101abd8 100644
--- a/IGC/Compiler/CISACodeGen/Platform.hpp
+++ b/IGC/Compiler/CISACodeGen/Platform.hpp
@@ -596,6 +596,7 @@ bool hasNoInt64Inst() const {
         m_platformInfo.eProductFamily == IGFX_ROCKETLAKE ||
         m_platformInfo.eProductFamily == IGFX_ALDERLAKE_S ||
         m_platformInfo.eProductFamily == IGFX_ALDERLAKE_P ||
+        m_platformInfo.eProductFamily == IGFX_RAPTORLAKE_S ||
         m_platformInfo.eProductFamily == IGFX_DG1;
 }
 
@@ -609,6 +610,7 @@ bool hasNoFP64Inst() const {
         m_platformInfo.eProductFamily == IGFX_ROCKETLAKE ||
         m_platformInfo.eProductFamily == IGFX_ALDERLAKE_S ||
         m_platformInfo.eProductFamily == IGFX_ALDERLAKE_P ||
+        m_platformInfo.eProductFamily == IGFX_RAPTORLAKE_S ||
         m_platformInfo.eProductFamily == IGFX_DG1;
 }
 
@@ -621,7 +623,8 @@ bool hasCorrectlyRoundedMacros() const {
         m_platformInfo.eProductFamily != IGFX_ROCKETLAKE &&
         m_platformInfo.eProductFamily != IGFX_DG1 &&
         m_platformInfo.eProductFamily != IGFX_ALDERLAKE_S &&
-        m_platformInfo.eProductFamily != IGFX_ALDERLAKE_P;
+        m_platformInfo.eProductFamily != IGFX_ALDERLAKE_P &&
+        m_platformInfo.eProductFamily != IGFX_RAPTORLAKE_S;
 }
 
 bool hasFusedEU() const { return m_platformInfo.eRenderCoreFamily >= IGFX_GEN12_CORE; }
diff --git a/IGC/common/ShaderOverride.cpp b/IGC/common/ShaderOverride.cpp
index 52910f36494a..74ffd7c64d1d 100644
--- a/IGC/common/ShaderOverride.cpp
+++ b/IGC/common/ShaderOverride.cpp
@@ -129,6 +129,7 @@ iga_gen_t GetIGAPlatform(PLATFORM const & platform)
             || ProductFamily == IGFX_ROCKETLAKE
             || ProductFamily == IGFX_ALDERLAKE_S
             || ProductFamily == IGFX_ALDERLAKE_P
+            || ProductFamily == IGFX_RAPTORLAKE_S
            )
         {
             return IGA_GEN12p1;
diff --git a/IGC/common/SystemThread.cpp b/IGC/common/SystemThread.cpp
index f8f8472defff..1fa6227b2236 100644
--- a/IGC/common/SystemThread.cpp
+++ b/IGC/common/SystemThread.cpp
@@ -516,6 +516,7 @@ CGenSystemInstructionKernelProgram* CGenSystemInstructionKernelProgram::Create(
             case IGFX_ROCKETLAKE:
             case IGFX_ALDERLAKE_S:
             case IGFX_ALDERLAKE_P:
+            case IGFX_RAPTORLAKE_S:
                 SIPIndex = GEN12_LP_CSR;
                 break;
 
diff --git a/IGC/common/VCPlatformSelector.hpp b/IGC/common/VCPlatformSelector.hpp
index aa9271490cab..d16545148c92 100644
--- a/IGC/common/VCPlatformSelector.hpp
+++ b/IGC/common/VCPlatformSelector.hpp
@@ -49,6 +49,8 @@ inline const char *getPlatformStr(PLATFORM Platform, unsigned &RevId) {
       return "ADLS";
     if (Product == IGFX_ALDERLAKE_P)
       return "ADLP";
+    if (Product == IGFX_RAPTORLAKE_S)
+      return "RPLS";
     else if (Product == IGFX_XE_HP_SDV)
       return "XEHP";
     else if (Product == IGFX_XE_HP_SDV)
diff --git a/inc/common/igfxfmid.h b/inc/common/igfxfmid.h
index 9b315c50e4d9..d31bbbed8ac5 100644
--- a/inc/common/igfxfmid.h
+++ b/inc/common/igfxfmid.h
@@ -29,6 +29,7 @@ typedef enum {
     IGFX_ROCKETLAKE,
     IGFX_ALDERLAKE_S,
     IGFX_ALDERLAKE_P,
+    IGFX_RAPTORLAKE_S,
     IGFX_DG1 = 1210,
     IGFX_XE_HP_SDV = 1250,
     IGFX_MAX_PRODUCT,
@@ -636,4 +637,14 @@ typedef enum __NATIVEGTTYPE
 #define DEV_ID_46C2                             0x46C2
 #define DEV_ID_46C3                             0x46C3
 
+//RPL-S
+#define DEV_ID_A780                             0xA780
+#define DEV_ID_A781                             0xA781
+#define DEV_ID_A782                             0xA782
+#define DEV_ID_A783                             0xA783
+#define DEV_ID_A788                             0xA788
+#define DEV_ID_A789                             0xA789
+#define DEV_ID_A78A                             0xA78A
+#define DEV_ID_A78B                             0xA78B
+
 #endif
-- 
2.34.0

