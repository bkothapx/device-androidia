From 75ef3f45245a29b5f8aa2bbcca9d29c56ae7c888 Mon Sep 17 00:00:00 2001
From: Zhuo Peng <zhuo.peng@intel.com>
Date: Fri, 28 Aug 2020 21:23:01 +0800
Subject: [PATCH] Add Power and Volume Button support in Guest VM

Change-Id: I0a732825d6d95b369296a5e319c849e2ed64402f
Signed-off-by: Zhuo Peng <zhuo.peng@intel.com>
Tracked-On: OAM-92622
---
 scripts/setup_host.sh |  6 ++++++
 scripts/start_civ.sh  | 23 +++++++++++++++++++++++
 2 files changed, 29 insertions(+)

diff --git a/scripts/setup_host.sh b/scripts/setup_host.sh
index 9d6649b..9a651ef 100755
--- a/scripts/setup_host.sh
+++ b/scripts/setup_host.sh
@@ -186,6 +186,11 @@ function install_auto_start_service(){
     sudo systemctl enable $service_file
 }

+function setup_power_button(){
+    sudo sed -i 's/#*HandlePowerKey=\w*/HandlePowerKey=ignore/' /etc/systemd/logind.conf
+    reboot_required=1
+}
+
 function ubu_thermal_conf() {
     #starting Intel Thermal Deamon, currently supporting CML/EHL only.
     sudo systemctl stop thermald.service
@@ -197,6 +202,7 @@ function ubu_thermal_conf() {

 function set_host_ui() {
     if [[ $1 == "headless" ]]; then
+        setup_power_button
         [[ $(systemctl get-default) == "multi-user.target" ]] && return 0
         sudo systemctl set-default multi-user.target
         reboot_required=1
diff --git a/scripts/start_civ.sh b/scripts/start_civ.sh
index 6f3fea6..44ca166 100755
--- a/scripts/start_civ.sh
+++ b/scripts/start_civ.sh
@@ -47,6 +47,8 @@ GUEST_QMP_PIPE=
 GUEST_AAF="-fsdev local,security_model=none,id=fsdev_aaf,path=$WORK_DIR/aaf -device virtio-9p-pci,fsdev=fsdev_aaf,mount_tag=aaf"
 GUEST_AAF_DIR=$WORK_DIR/aaf
 GUEST_AAF_CONFIG=$GUEST_AAF_DIR/mixins.spec
+GUEST_POWER_BUTTON=
+GUEST_GRAPHIC_MODE=

 GUEST_STATIC_OPTION="\
  -name caas-vm \
@@ -357,6 +359,7 @@ function setup_ramfb_vga() {

 function set_graphics() {
     OIFS=$IFS IFS=',' sub_param=($1) IFS=$OIFS
+    GUEST_GRAPHIC_MODE=${sub_param[0]}

     if [[ ${sub_param[0]} == "GVT-d" ]]; then
         setup_gvtd ${sub_param[@]} || return -1
@@ -558,6 +561,20 @@ function setup_qmp_pipe() {
     GUEST_QMP_PIPE="-qmp pipe:$qmp_pipe"
 }

+function set_guest_pwr_vol_button() {
+    echo "Guest graphic mode is $GUEST_GRAPHIC_MODE"
+    if [[ $GUEST_GRAPHIC_MODE == "GVT-d" ]]; then
+        cd $SCRIPTS_DIR
+        sudo ./vinput-manager --gvtd
+        GUEST_POWER_BUTTON='-qmp unix:./qmp-vinput-sock,server,nowait -device virtio-input-host-pci,evdev=/dev/input/by-id/Power-Button-vm0 -device virtio-input-host-pci,evdev=/dev/input/by-id/Volume-Button-vm0'
+    else
+        cd $SCRIPTS_DIR
+        sudo ./vinput-manager
+        GUEST_POWER_BUTTON='-device virtio-input-host-pci,evdev=/dev/input/by-id/Power-Button-vm0 -device virtio-input-host-pci,evdev=/dev/input/by-id/Volume-Button-vm0'
+    fi
+    cd -
+}
+
 function cleanup() {
     cleanup_rpmb_dev
     cleanup_thermal_mediation
@@ -607,6 +624,7 @@ function launch_guest() {
               $GUEST_WIFI_PT_DEV \
               $GUEST_PM_CTRL \
               $GUEST_TIME_KEEP \
+              $GUEST_POWER_BUTTON \
               $GUEST_QMP_PIPE \
               $GUSET_VTPM \
               $GUEST_AAF \
@@ -650,6 +668,7 @@ function show_help() {
     printf "\t--qmp-pipe specify the name of the pipe used for qmp communication.\n"
     printf "\t--allow-suspend option allow guest enter S3 state, by default guest cannot enter S3 state.\n"
     printf "\t--disable-kernel-irqchip set kernel_irqchip=off.\n"
+    printf "\t--passthrough-pwr-vol-button passthrough the power button and volume button to guest.\n"
 }

 function parse_arg() {
@@ -759,6 +778,10 @@ function parse_arg() {
                 disable_kernel_irq_chip
                 ;;

+            --passthrough-pwr-vol-button)
+                set_guest_pwr_vol_button
+                ;;
+
             -?*)
                 echo "Error: Invalid option $1"
                 show_help
--
2.17.1

