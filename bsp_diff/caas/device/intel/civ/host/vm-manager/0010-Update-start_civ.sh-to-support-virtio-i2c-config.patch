From 67b70fd052359238aeb1242f497f70bcf363cc2e Mon Sep 17 00:00:00 2001
From: Zhuocheng Ding <zhuocheng.ding@intel.com>
Date: Mon, 14 Sep 2020 13:25:10 +0800
Subject: [PATCH] Update start_civ.sh to support virtio i2c config

Change-Id: Iaecc72f5bc69ecf99373af27bae3f81b4c2d7ab9
Tracked-On: OAM-92885
Signed-off-by: Zhuocheng Ding <zhuocheng.ding@intel.com>

diff --git a/scripts/start_civ.sh b/scripts/start_civ.sh
index 924a38c..ca855e9 100755
--- a/scripts/start_civ.sh
+++ b/scripts/start_civ.sh
@@ -41,6 +41,7 @@ GUEST_WIFI_PT_DEV=
 GUEST_ACPI_SSDT=
 GUEST_I2C_PT_DEV=
 GUEST_VIRTIO_GPIO=
+GUEST_VIRTIO_I2C=
 GUEST_PM_CTRL=
 GUEST_TIME_KEEP=
 GUSET_VTPM="-chardev socket,id=chrtpm,path=$WORK_DIR/vtpm0/swtpm-sock -tpmdev emulator,id=tpm0,chardev=chrtpm -device tpm-crb,tpmdev=tpm0"
@@ -432,7 +433,6 @@ function set_virtio_gpio() {
     local gpiomap_file="${SCRIPTS_DIR}/skucfg/${sku}/virtio_gpio.map"
     local gpiomap=()
     local gpiocfg=()
-    local idx=0
     if [[ -f "${gpiomap_file}" ]]; then
         IFS=$'\n' read -d '' -r -a gpiomap < $gpiomap_file
         for elem in "${gpiomap[@]}"; do
@@ -446,6 +446,25 @@ function set_virtio_gpio() {
     fi
 }

+function set_virtio_i2c() {
+    local sku=$1
+    local i2cmap_file="${SCRIPTS_DIR}/skucfg/${sku}/virtio_i2c.map"
+    local i2cmap=()
+    local i2ccfg=()
+    if [[ -f "${i2cmap_file}" ]]; then
+        IFS=$'\n' read -d '' -r -a i2cmap < $i2cmap_file
+        for elem in "${i2cmap[@]}"; do
+            if [[ "${elem}" != \#* ]]; then
+                i2ccfg+=("${elem}")
+            fi
+        done
+    fi
+    if [[ ${#i2ccfg[@]} -ge 3 ]]; then
+        local busnum=`find "/sys/bus/pci/devices/${i2ccfg[0]}/" -name "i2c-*" | sed -r "s/.*i2c-([0-9]+).*/\1/;q"`
+        GUEST_VIRTIO_I2C="-device virtio-i2c-pci,id=virtio-i2c,bus=pcie.0,addr=${i2ccfg[2]},i2c-device=$busnum:${i2ccfg[1]}"
+    fi
+}
+
 function set_extra_qcmd() {
     GUEST_EXTRA_QCMD=$1
 }
@@ -692,6 +711,7 @@ function launch_guest() {
               $GUEST_ACPI_SSDT \
               $GUEST_I2C_PT_DEV \
               $GUEST_VIRTIO_GPIO \
+              $GUEST_VIRTIO_I2C \
               $GUEST_PM_CTRL \
               $GUEST_TIME_KEEP \
               $GUEST_POWER_BUTTON \
@@ -725,6 +745,7 @@ function show_help() {
     printf "\t-b  specify host block device as guest virtual device, eg.\" -b /dev/mmcblk0 \"\n"
     printf "\t-ssdt  specify extra per-SKU ACPI ssdt table to guest, eg.\" -ssdt <sku> \"\n"
     printf "\t-vgpio  specify extra per-SKU VirtIO GPIO mapping to guest, eg.\" -vgpio <sku> \"\n"
+    printf "\t-vi2c  specify extra per-SKU VirtIO I2C mapping to guest, eg.\" -vi2c <sku> \"\n"
     printf "\t-e  specify extra qemu cmd, eg. \"-e \"-full-screen -monitor stdio\"\"\n"
     printf "\t--passthrough-pci-usb passthrough USB PCI bus to guest.\n"
     printf "\t--passthrough-pci-udc passthrough USB Device Controller ie. UDC PCI bus to guest.\n"
@@ -803,6 +824,11 @@ function parse_arg() {
                 shift
                 ;;

+            -vi2c)
+                set_virtio_i2c $2
+                shift
+                ;;
+
             -e)
                 set_extra_qcmd "$2"
                 shift
--
2.25.1

