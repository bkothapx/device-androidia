From 714c0f3e0da80c7120dbe40b29ef90772e814d2c Mon Sep 17 00:00:00 2001
From: rramakax <rohitx.kant@intel.com>
Date: Tue, 15 Sep 2020 20:23:06 +0530
Subject: [PATCH] [CIV] Enable disk swap for Chromium kernel.

Change-Id: I96ae547818089392411c126451b4cb1a77fb8165
Tracked-On: OAM-91636
Signed-off-by: rramakax <rohitx.kant@intel.com>
---
 groups/kernel/gmin64/config-lts/lts2019-chromium/x86_64_defconfig | 2 +-
 groups/swap/zram_auto/init.rc                                     | 4 ++++
 groups/swap/zram_auto/option.spec                                 | 1 +
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/groups/kernel/gmin64/config-lts/lts2019-chromium/x86_64_defconfig b/groups/kernel/gmin64/config-lts/lts2019-chromium/x86_64_defconfig
index ebed5eb..5329dbe 100644
--- a/groups/kernel/gmin64/config-lts/lts2019-chromium/x86_64_defconfig
+++ b/groups/kernel/gmin64/config-lts/lts2019-chromium/x86_64_defconfig
@@ -37,7 +37,7 @@ CONFIG_KERNEL_GZIP=y
 # CONFIG_KERNEL_LZ4 is not set
 CONFIG_DEFAULT_HOSTNAME="localhost"
 CONFIG_SWAP=y
-# CONFIG_DISK_BASED_SWAP is not set
+CONFIG_DISK_BASED_SWAP=y
 # CONFIG_SYSVIPC is not set
 CONFIG_POSIX_MQUEUE=y
 CONFIG_POSIX_MQUEUE_SYSCTL=y
diff --git a/groups/swap/zram_auto/init.rc b/groups/swap/zram_auto/init.rc
index 3d27ba8..ce05214 100644
--- a/groups/swap/zram_auto/init.rc
+++ b/groups/swap/zram_auto/init.rc
@@ -6,6 +6,10 @@ on boot
    # Avoid evicting pages and use zram disk
     write /proc/sys/vm/swappiness 100
 {{/swappiness}}
+{{#disk_based_swap}}
+   # Enable disk_based_swap on Chromium kernels
+    write /proc/sys/vm/disk_based_swap 1
+{{/disk_based_swap}}

 on post-fs
     exec - system system -- /vendor/bin/check_lowmem.sh
diff --git a/groups/swap/zram_auto/option.spec b/groups/swap/zram_auto/option.spec
index 1cbc510..4f550ef 100644
--- a/groups/swap/zram_auto/option.spec
+++ b/groups/swap/zram_auto/option.spec
@@ -1,3 +1,4 @@
 [defaults]
 size = 104857600
 swappiness = false
+disk_based_swap = false
--
1.9.1

