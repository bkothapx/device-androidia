From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Basil Chew <basil.chew@intel.com>
Date: Thu, 19 Aug 2021 16:56:28 +0800
Subject: [PATCH] Mixins update - mixins_sriov_changes

---
diff --git a/caas/BoardConfig.mk b/caas/BoardConfig.mk
index 6c94465..3dc8ba2 100644
--- a/caas/BoardConfig.mk
+++ b/caas/BoardConfig.mk
@@ -492,14 +492,15 @@ endif

 ifeq ($(BASE_LTS2020_YOCTO_KERNEL),true)
 BOARD_KERNEL_CMDLINE += i915.enable_guc=1
+BOARD_KERNEL_CMDLINE += i915.force_probe=*
 endif

 USE_OPENGL_RENDERER := true
 USE_INTEL_UFO_DRIVER := false
-BOARD_GPU_DRIVERS := i965 swrast virgl iris
+BOARD_GPU_DRIVERS := i965 swrast virgl iris kmsro
 BOARD_USE_CUSTOMIZED_MESA := true

-BOARD_GPU_DRIVERS ?= i965 swrast virgl iris
+BOARD_GPU_DRIVERS ?= i965 swrast virgl iris kmsro
 ifneq ($(strip $(BOARD_GPU_DRIVERS)),)
 TARGET_HARDWARE_3D := true
 TARGET_USES_HWC2 := true
diff --git a/caas/extra_files/media/auto_hal.in b/caas/extra_files/media/auto_hal.in
index f307863..5c7be0a 100644
--- a/caas/extra_files/media/auto_hal.in
+++ b/caas/extra_files/media/auto_hal.in
@@ -14,7 +14,7 @@ case "$(cat /proc/fb)" in
                 ;;
         *)
                 echo "software codec"
-                setprop vendor.intel.video.codec software
+                setprop vendor.intel.video.codec hardware
                 ;;
 esac
 }
diff --git a/caas/init.rc b/caas/init.rc
index 9f1761b..dd511f8 100644
--- a/caas/init.rc
+++ b/caas/init.rc
@@ -186,6 +186,15 @@ on post-fs
     insmod /vendor/lib/modules/asix.ko
     insmod /vendor/lib/modules/r8152.ko
     insmod /vendor/lib/modules/r8169.ko
+    insmod /vendor/lib/modules/kvmfr.ko
+    chown system system /dev/uio0
+    chown system system /dev/kvmfr0
+
+#       grep -q '^uio'   /proc/modules || sudo modprobe uio
+#       grep -q '^kvmfr' /proc/modules && sudo rmmod kvmfr || true
+#       sudo insmod ./kvmfr.ko
+#       sudo chown $(USER) /dev/uio0
+#       sudo chown $(USER) /dev/kvmfr0
 ##############################################################
 # Source: device/intel/mixins/groups/trusty/true/init.rc
 ##############################################################
@@ -240,15 +249,15 @@ service hdcpd /system/vendor/bin/hdcpd
     group media shell
     seclabel u:r:hdcpd:s0

-on property:vendor.hwc.ready=1
-    start hdcpd
+#on property:vendor.hwc.ready=1
+#    start hdcpd

 on post-fs-data
     # Change ownership of pci syfs file to 'media', as hdcpd runs as 'media'
     chown media media /sys/devices/pci0000\:00/0000\:00\:02.0/resource0
     mkdir /data/system 0770 system system
     mkdir /data/vendor/coreu 0770 media root
-    mkdir /data/vendor/hdcp 0770 media root
+#    mkdir /data/vendor/hdcp 0770 media root
 on boot
     #Give permission to system to use i915_videostatus sysfs interface
     chown system system /sys/class/drm/card0/power/i915_videostatus
-- 
2.17.1

