From 05c66e474a8ebd1a512bb54c647b3c9ed2f87383 Mon Sep 17 00:00:00 2001
From: "Chew, Tong Liang" <tong.liang.chew@intel.com>
Date: Wed, 6 Jul 2022 00:46:19 +0530
Subject: [PATCH 5/6] iris/kmsro: use ro device to allocate scanout for render


Tracked-On: OAM-102839
Signed-of-by: Shekhar Chauhan <shekhar.chauhan@intel.com>
---
 src/gallium/drivers/iris/iris_resource.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/gallium/drivers/iris/iris_resource.c b/src/gallium/drivers/iris/iris_resource.c
index 9c839bab357..2f58f6c71b2 100644
--- a/src/gallium/drivers/iris/iris_resource.c
+++ b/src/gallium/drivers/iris/iris_resource.c
@@ -988,11 +988,14 @@ iris_resource_create_with_modifiers(struct pipe_screen *pscreen,
 {
    struct iris_screen *screen = (struct iris_screen *)pscreen;
    struct gen_device_info *devinfo = &screen->devinfo;
+   struct pipe_resource *pres;
    
    if (screen->ro &&
        (templ->bind & (PIPE_BIND_DISPLAY_TARGET |
                        PIPE_BIND_SCANOUT | PIPE_BIND_SHARED))) {
-      return iris_resource_create_renderonly(pscreen, templ);
+      pres = iris_resource_create_renderonly(pscreen, templ);
+      if (pres)
+	      return pres;
    }
 
    struct iris_resource *res = iris_alloc_resource(pscreen, templ);
@@ -1409,8 +1412,8 @@ iris_resource_get_handle(struct pipe_screen *pscreen,
    case WINSYS_HANDLE_TYPE_SHARED:
       return iris_bo_flink(bo, &whandle->handle) == 0;
    case WINSYS_HANDLE_TYPE_KMS: {
-      if (screen->ro) {
-         assert(res->scanout);
+      if (screen->ro && res->scanout) {
+         //assert(res->scanout);
          return renderonly_get_handle(res->scanout, whandle);
       }
       /* Because we share the same drm file across multiple iris_screen, when
-- 
2.17.1

